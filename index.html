<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edebiyat Çarkı</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* SVG özel stilleri - Tailwind ile yapılamayan */
    .cabin { stroke: #b26e00; stroke-width: 1; }
    .cabinNumberNight { font-size: 12px; fill: #0f172a; font-weight: 800; }
    .ground { fill: #071a28; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-800 flex items-center justify-center p-4">
  <div class="w-full max-w-6xl bg-slate-900/80 backdrop-blur-sm border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
    <h1 class="text-3xl font-bold text-cyan-300 mb-6 text-center pt-6">Edebiyat Çarkı</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 px-4 pb-6">
      <!-- 1. kutu: SVG çark -->
      <div class="md:col-span-2 md:row-span-3 lg:col-span-4 lg:row-span-4 bg-slate-950/60 rounded-xl border border-slate-700 p-4">
        <svg id="svgWheel" viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg" aria-label="Dönme dolap örneği" class="w-full h-auto">
          <!-- sky background -->
          <rect id="sky" x="0" y="0" width="900" height="520" fill="#02102a" />
          <g id="stars"></g>
          <rect x="0" y="520" width="900" height="80" fill="#071a28"/>
          <ellipse id="groundShadow" cx="450" cy="560" rx="160" ry="24" fill="rgba(0,0,0,0.45)"/>
          <g id="legs">
            <path d="M390 560 L420 320 L438 320 L408 560 Z" fill="var(--leg)" opacity="0.95"/>
            <path d="M510 560 L480 320 L462 320 L492 560 Z" fill="var(--leg)" opacity="0.95"/>
            <rect x="376" y="552" width="70" height="12" rx="4" fill="#2a1b14" opacity="0.95"/>
            <rect x="454" y="552" width="70" height="12" rx="4" fill="#2a1b14" opacity="0.95"/>
            <rect x="410" y="420" width="80" height="10" rx="5" fill="#1e1a17" transform="rotate(-10 450 425)"/>
            <rect x="410" y="440" width="80" height="10" rx="5" fill="#1e1a17" transform="rotate(10 450 445)"/>
          </g>
          <g id="wheelGroup" transform="translate(450 360)">
            <g id="lights"></g>
            <circle cx="0" cy="0" r="180" fill="none" stroke="#0d4a6f" stroke-width="14" />
            <circle cx="0" cy="0" r="140" fill="none" stroke="#13364a" stroke-width="6" />
            <g id="spokes"></g>
            <circle cx="0" cy="0" r="20" fill="#0f2b3a" />
            <circle cx="0" cy="0" r="10" fill="#1b4b68" />
          </g>
          <circle id="pivotCover" cx="450" cy="360" r="22" fill="#071a28"/>
        </svg>
      </div>

      <!-- 2. kutu: Sonuç paneli -->
      <div class="md:row-span-3 lg:row-span-4 lg:col-start-5 bg-slate-800/70 backdrop-blur border border-slate-600 rounded-xl p-5 flex flex-col">
        <h3 class="text-lg font-semibold text-cyan-300 mb-3">Seçilen Eser</h3>
        <p id="defaultResultText" class="text-slate-300 text-sm flex-grow">Çarkı çevirip durduğunda seçilen eser burada gözükecek.</p>
        <div id="resultCard" class="hidden flex-grow flex flex-col gap-2 text-sm">
          <h4 class="font-bold text-cyan-200"></h4>
          <p class="type text-amber-300 font-medium"></p>
          <p class="author text-slate-300"><strong>Yazar:</strong> <span></span></p>
          <p class="text text-slate-400 italic"></p>
        </div>
      </div>

      <!-- 3. kutu: Kontrol paneli -->
      <div class="md:col-span-2 lg:col-span-3 lg:row-start-5 bg-slate-800/60 backdrop-blur border border-slate-600 rounded-xl p-4">
        <button id="spinBtn" class="w-full py-4 px-6 rounded-xl bg-gradient-to-r from-cyan-600 to-blue-700 hover:from-cyan-500 hover:to-blue-600 text-white font-semibold shadow-lg transition-all duration-200 cursor-pointer select-none">
          Basılı Tut → Dön
        </button>
        <p class="text-xs text-slate-300 mt-3 bg-slate-900/40 rounded-lg p-2">
          Mobil: butona basılı tutun veya üzerine dokunun. Bıraktığınızda seçtiğiniz süre içinde duracak şekilde yavaşlar.
        </p>
        <div class="mt-3 flex justify-between items-center text-xs text-slate-300">
          <span><strong>Hız:</strong> <span id="speedLabel">0.00</span> rad/s</span>
          <span><strong>Durma:</strong> <span id="stopTarget">3.5</span>s</span>
        </div>
        <label class="block mt-3 text-xs text-slate-300">
          Durma süresi ayarla:
          <input id="stopRange" type="range" min="2" max="5" step="0.1" value="3.5" class="w-full mt-1 accent-cyan-500">
        </label>
      </div>

      <!-- 4. kutu: JSON yükleme -->
      <div class="md:col-span-1 md:col-start-3 lg:col-span-2 lg:col-start-4 lg:row-start-5 bg-slate-800/60 backdrop-blur border border-slate-600 rounded-xl p-4">
        <label for="jsonFile" class="block text-xs font-medium text-slate-300 mb-2">Kartları JSON Dosyasından Yükle:</label>
        <input type="file" id="jsonFile" accept="application/json" class="block w-full text-xs text-slate-300 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:bg-cyan-600 file:text-slate-900 file:font-medium hover:file:bg-cyan-500 file:cursor-pointer">
        <button id="loadJsonBtn" class="mt-2 w-full py-1.5 bg-cyan-600 hover:bg-cyan-500 text-slate-900 font-bold rounded-lg text-sm transition-colors">
          Yükle
        </button>
        <p class="text-[10px] text-slate-400 mt-2">
          Dosya yüklenmezse örnek içerik kullanılır.
        </p>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    let NUM_CABINS = 12;
    const RIM_RADIUS = 180;
    const CABIN_DIST = RIM_RADIUS;
    const CABIN_SIZE = 28;
    const LIGHT_COUNT = NUM_CABINS * 6;

    // Physics
    let angle = 0; // radians
    let angVel = 0; // radians / sec
    let pressing = false;

    const maxAngVel = 6.0;
    const accelWhilePress = 4.0;
    const stopTargetInput = document.getElementById('stopRange');

    // refs
    const svg = document.getElementById('svgWheel');
    const wheelGroup = document.getElementById('wheelGroup');
    const spokesGroup = document.getElementById('spokes');
    const lightsGroup = document.getElementById('lights');
    const starsGroup = document.getElementById('stars');
    const spinBtn = document.getElementById('spinBtn');
    const speedLabel = document.getElementById('speedLabel');
    const stopTargetLabel = document.getElementById('stopTarget');

    // default literaryWorks (fallback)
    let literaryWorks = [
      { "id":"1","Başlık": "Alice Harikalar Diyarında", "Tür": "Kitap", "Yazar": "Lewis Carroll", "Metin": "Alice, bir tavşan deliğinden düşerek fantastik bir dünyaya ulaşır." },
      { "id":"2","Başlık": "Martılar", "Tür": "Şiir", "Yazar": "Cahit Sıtkı Tarancı", "Metin": "Martılara özlemle bakış..." },
      { "id":"3","Başlık": "İnce Memed", "Tür": "Edebi Metin", "Yazar": "Yaşar Kemal", "Metin": "Her insan öldürür gene de sevdiğini\nBu böyle bilinsin herkes tarafından,\nKiminin ters bakışından gelir ölüm,\nKiminin iltifatından,\nKorkağın öpücüğünden,\nCesurun kılıcından!\n\nKimisi aşkını gençlikte öldürür,\nYaşını başını almışken kimi;\nBiri Şehvet'in elleriyle boğazlar,\nBirinin altındır elleri,\nYumuşak kalpli bıçak kullanır\nÇünkü ceset soğur hemen.\n\nKimi pek az sever, kimi derinden,\nBiri müşteridir, diğeri satıcı;\nKimi vardır, gözyaşlarıyla bitirir işi,\nKiminden ne bir ah, ne bir figan:\nÇünkü her insan öldürür sevdiğini,\nGene de ölmez insan." }
    ];

    // Try to fetch sample JSON (uploaded to server as sample_cards.json) and use if available.
    fetch('./sample_cards.json').then(r=>{
      if(!r.ok) throw new Error('no sample');
      return r.json();
    }).then(js=>{
      if(Array.isArray(js) && js.length>0){
        literaryWorks = js;
        NUM_CABINS = literaryWorks.length;
        console.log('Sample JSON loaded from server,', js.length, 'items');
      }
      // After potential load, create the cabins
      createCabinsAndLights();
    }).catch(err=>{
      console.log('No sample JSON loaded from server - using defaults.');
      createCabinsAndLights();
    });

    // helper
    function svgn(tag){ return document.createElementNS('http://www.w3.org/2000/svg', tag); }

    // create stars
    (function createStars(){
      const W = 900, H = 520;
      for(let i=0;i<120;i++){
        const x = Math.random()*W;
        const y = Math.random()*H*0.7;
        const r = Math.random()*1.6 + 0.3;
        const c = svgn('circle');
        c.setAttribute('cx', x);
        c.setAttribute('cy', y);
        c.setAttribute('r', r);
        c.setAttribute('fill', 'white');
        c.setAttribute('opacity', (Math.random()*0.7+0.2).toFixed(2));
        starsGroup.appendChild(c);
      }
    })();

    
    // 0-bazlı alttaki kabin indeksi (her NUM_CABINS için doğru çalışır)
    function getBottomCabinIndex(currentAngleRad, cabinCount){
      const twoPi = 2*Math.PI;
      // Açıyı [0, 2π) aralığına normalize et
      let a = currentAngleRad % twoPi;
      if (a < 0) a += twoPi;

      const step = twoPi / cabinCount;
      // Geometri: i ≈ (π - a) / step  0-bazlı, en yakın kabini bulmak için yuvarla
      let idx = Math.round((Math.PI - a) / step) % cabinCount;
      if (idx < 0) idx += cabinCount;
      return idx; // 0..cabinCount-1
    }

    // createCabinsAndLights - now a proper function (callable)
    function createCabinsAndLights(){
      while(spokesGroup.firstChild) spokesGroup.removeChild(spokesGroup.firstChild);
      while(lightsGroup.firstChild) lightsGroup.removeChild(lightsGroup.firstChild);

      for(let i=0;i<NUM_CABINS;i++){
        // start numbering at top (12 o'clock) and go clockwise
        const theta = (i/NUM_CABINS)*Math.PI*2 - Math.PI/2;
        const line = svgn('line');
        line.setAttribute('x1',0); line.setAttribute('y1',0);
        line.setAttribute('x2', Math.cos(theta)*RIM_RADIUS);
        line.setAttribute('y2', Math.sin(theta)*RIM_RADIUS);
        line.setAttribute('stroke','#1b495c'); line.setAttribute('stroke-width','3');
        spokesGroup.appendChild(line);

        const cabinG = svgn('g');
        cabinG.setAttribute('class','cabinG'); cabinG.setAttribute('data-index', i);
        const cx = Math.cos(theta)*CABIN_DIST; const cy = Math.sin(theta)*CABIN_DIST;
        cabinG.setAttribute('transform', `translate(${cx} ${cy})`);

        const arm = svgn('line'); arm.setAttribute('x1',0); arm.setAttribute('y1',0); arm.setAttribute('x2',0); arm.setAttribute('y2',18);
        arm.setAttribute('stroke','#0b1b22'); arm.setAttribute('stroke-width','2'); cabinG.appendChild(arm);

        const rect = svgn('rect'); rect.setAttribute('x', -CABIN_SIZE/2); rect.setAttribute('y', 18);
        rect.setAttribute('width', CABIN_SIZE); rect.setAttribute('height', CABIN_SIZE*0.8); rect.setAttribute('rx',6);
        rect.setAttribute('class','cabin'); rect.setAttribute('fill', getColorForIndex(i)); rect.setAttribute('stroke','#9b6a00'); rect.setAttribute('stroke-width','1.5');
        cabinG.appendChild(rect);

        const win = svgn('rect'); win.setAttribute('x', -6); win.setAttribute('y', 22); win.setAttribute('width', 12); win.setAttribute('height', 12); win.setAttribute('rx',2); win.setAttribute('fill','#fff'); win.setAttribute('opacity','0.95'); cabinG.appendChild(win);

        // numbering: top == 12
        //const cabinNumber = i === 0 ? NUM_CABINS : i;
        const cabinNumber = i + 1;
        const num = svgn('text'); num.setAttribute('class','cabinNumberNight'); num.setAttribute('x','0');
        const cabinCenterY = 18 + (CABIN_SIZE*0.8)/2 + 4; num.setAttribute('y', cabinCenterY); num.setAttribute('text-anchor','middle'); num.textContent = String(cabinNumber);
        cabinG.appendChild(num);

        spokesGroup.appendChild(cabinG);
      }

      // lights
      for(let i=0;i<LIGHT_COUNT;i++){
        const theta = (i/LIGHT_COUNT)*Math.PI*2 - Math.PI/2;
        const lx = Math.cos(theta)*(RIM_RADIUS+10);
        const ly = Math.sin(theta)*(RIM_RADIUS+10);
        const light = svgn('circle'); light.setAttribute('cx', lx); light.setAttribute('cy', ly); light.setAttribute('r',5);
        light.setAttribute('class','rimLight'); light.dataset.index = i; lightsGroup.appendChild(light);
      }
    }

    function getColorForIndex(i){
      const palette = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFBE0B", "#FB5607", "#8338EC", "#3A86FF", "#06D6A0", "#FF9E00", "#9B5DE5", "#00BBF9", "#F15BB5"];
      return palette[i % palette.length];
    }

    // JSON upload handler (user file)
    document.getElementById('loadJsonBtn').addEventListener('click', loadJsonData);

    function loadJsonData(){
      const fileInput = document.getElementById('jsonFile'); const file = fileInput.files[0];
      if(!file){ alert('Lütfen bir JSON dosyası seçin!'); return; }
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const jsonData = JSON.parse(e.target.result);
          if(Array.isArray(jsonData) && jsonData.length>0){ literaryWorks = jsonData; NUM_CABINS = literaryWorks.length; createCabinsAndLights(); alert(`${literaryWorks.length} kart başarıyla yüklendi!`); }
          else alert('JSON doğru formatta bir dizi içermiyor.');
          // no writing anywhere — just use in memory
        }catch(err){ alert('JSON ayrıştırma hatası: '+err.message); }
        // update visuals even if number of cabins stays 12
        createCabinsAndLights();
      };
      reader.readAsText(file);
    }

    // animation loop
    let lastTs = null; let releaseDecel = 0;

    function startPress(e){ e.preventDefault(); pressing = true; spinBtn.textContent = 'BASILI TUTULUYOR...'; spinBtn.setAttribute('aria-pressed','true'); }
    function endPress(e){ if(e) e.preventDefault(); if(!pressing) return; pressing = false; const stopTime = parseFloat(stopTargetInput.value) || 3.5; releaseDecel = -angVel / stopTime; spinBtn.textContent = 'DURDURULUYOR...'; spinBtn.setAttribute('aria-pressed','false'); setTimeout(showSelectedResult, stopTime*1000); }

    spinBtn.addEventListener('mousedown', startPress); spinBtn.addEventListener('touchstart', startPress, {passive:false});
    spinBtn.addEventListener('mouseup', endPress); spinBtn.addEventListener('touchend', endPress); spinBtn.addEventListener('mouseleave', endPress);

    function showSelectedResult(){
      const cabinIndex = getBottomCabinIndex(angle, NUM_CABINS);
      const workIndex = cabinIndex % literaryWorks.length;
      const work = literaryWorks[workIndex] || { Başlık:'Başlıksız', Tür:'—', Yazar:'—', Metin:'—' };

      const card = document.getElementById('resultCard');
      card.querySelector('h4').textContent = work['Başlık'] || work['title'] || 'Başlıksız';
      card.querySelector('.type').textContent = work['Tür'] || work['type'] || 'Tür yok';
      card.querySelector('.author span').textContent = work['Yazar'] || work['author'] || 'Yok';
      //card.querySelector('.text').textContent = work['Metin'] || work['text'] || 'İçerik yok';

      const rawText = work['Metin'] || work['text'] || 'İçerik yok';
      card.querySelector('.text').innerHTML = rawText.replace(/\n/g, '<br>');

      card.classList.remove('hidden');
      document.getElementById('defaultResultText').classList.add('hidden');
      spinBtn.textContent = 'TEKRAR ÇEVİR!';
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function update(ts){ if(!lastTs) lastTs = ts; const dt = (ts-lastTs)/1000; lastTs = ts;
      if(pressing){ angVel += accelWhilePress * dt; if(angVel>maxAngVel) angVel = maxAngVel; }
      else { if(angVel>0){ angVel += releaseDecel * dt; if(angVel < 0.00005) angVel = 0; } }
      angle += angVel * dt;
      if(angVel === 0){ const snapStep = (2*Math.PI)/NUM_CABINS; angle = Math.round(angle / snapStep) * snapStep; }
      const deg = angle * 180/Math.PI; wheelGroup.setAttribute('transform', `translate(450 360) rotate(${deg})`);

      // cabins upright
      const cabinGroups = document.querySelectorAll('.cabinG'); cabinGroups.forEach(cg=>{
        const i = +cg.getAttribute('data-index'); const theta = (i/NUM_CABINS)*Math.PI*2 - Math.PI/2; const cx = Math.cos(theta)*CABIN_DIST; const cy = Math.sin(theta)*CABIN_DIST; cg.setAttribute('transform', `translate(${cx} ${cy}) rotate(${-deg})`);
      });

      // lights rainbow
      const lights = document.querySelectorAll('.rimLight'); lights.forEach(lt=>{ const i = +lt.dataset.index; const hueBase = (i / LIGHT_COUNT) * 360; const hueShift = (angle * 180/Math.PI) * 0.4; const hue = (hueBase + hueShift) % 360; const pulse = 0.7 + 0.3*Math.sin(angle*3 + i*0.5); lt.setAttribute('fill', `hsl(${hue},100%,${50*pulse}%)`); });

      speedLabel.textContent = angVel.toFixed(2);
      requestAnimationFrame(update);
    }

    // start loop
    requestAnimationFrame(update);

    // make stop range label reactive
    stopTargetInput.addEventListener('input', ()=>{ stopTargetLabel.textContent = stopTargetInput.value; });
    window.addEventListener('blur', ()=>{ if(pressing) endPress(); });

  </script>
</body>
</html>
