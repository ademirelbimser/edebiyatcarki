<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edebiyat Çarkı</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* SVG özel stilleri - Tailwind ile yapılamayan */
    .cabin{stroke:#b26e00;stroke-width:1}
    .cabinNumberNight{font-size:12px;fill:#102027;font-weight:800}
    .ground{fill:#071a28}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-950 to-slate-900 flex items-center justify-center p-4">
  <div class="w-full max-w-6xl bg-gradient-to-b from-slate-950 to-cyan-950 rounded-xl shadow-2xl p-6">
    <h1 class="text-2xl font-bold text-cyan-50 mb-6 text-center">Edebiyat Çarkı</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
      <!-- 1. kutu: Büyük ekranlarda 4x4, mobilde tam genişlik -->
      <div class="md:col-span-2 md:row-span-3 lg:col-span-4 lg:row-span-4 bg-blue-200 p-4">
        <!-- SVG ferris wheel -->
        <svg id="svgWheel" viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg" aria-label="Dönme dolap örneği">
          <!-- sky background -->
          <rect id="sky" x="0" y="0" width="900" height="520" fill="#02102a" />

          <!-- stars group (generated in JS) -->
          <g id="stars"></g>

          <!-- ground / shadow -->
          <rect x="0" y="520" width="900" height="80" fill="#071a28"/>
          <ellipse id="groundShadow" cx="450" cy="560" rx="160" ry="24" fill="rgba(0,0,0,0.45)"/>

          <!-- legs: adjusted so they touch the ground and look straight -->
          <g id="legs">
            <!-- left leg -->
            <path d="M390 560 L420 320 L438 320 L408 560 Z" fill="var(--leg)" opacity="0.95"/>
            <!-- right leg -->
            <path d="M510 560 L480 320 L462 320 L492 560 Z" fill="var(--leg)" opacity="0.95"/>
            <!-- foot plates to anchor legs to ground -->
            <rect x="376" y="552" width="70" height="12" rx="4" fill="#2a1b14" opacity="0.95"/>
            <rect x="454" y="552" width="70" height="12" rx="4" fill="#2a1b14" opacity="0.95"/>
            <!-- cross braces (slightly lower) -->
            <rect x="410" y="420" width="80" height="10" rx="5" fill="#1e1a17" transform="rotate(-10 450 425)"/>
            <rect x="410" y="440" width="80" height="10" rx="5" fill="#1e1a17" transform="rotate(10 450 445)"/>
          </g>

          <!-- wheel group (we will rotate this group). center Y moved down -->
          <g id="wheelGroup" transform="translate(450 360)">
            <!-- lights around rim (generated in JS) -->
            <g id="lights"></g>

            <!-- outer rim -->
            <circle cx="0" cy="0" r="180" fill="none" stroke="#0d4a6f" stroke-width="14" />
            <!-- inner rim -->
            <circle cx="0" cy="0" r="140" fill="none" stroke="#13364a" stroke-width="6" />

            <!-- spokes & cabins generated in JS for cleaner code; placeholder here -->
            <g id="spokes"></g>

            <!-- hub -->
            <circle cx="0" cy="0" r="20" fill="#0f2b3a" />
            <circle cx="0" cy="0" r="10" fill="#1b4b68" />
          </g>

          <!-- pivot cover to hide center join -->
          <circle id="pivotCover" cx="450" cy="360" r="22" fill="#071a28"/>
        </svg>
      </div>

      <!-- 2. kutu: Sağda, büyük ekranlarda 1 sütun yüksek -->
      <div class="md:row-span-3 lg:row-span-4 lg:col-start-5 bg-gradient-to-br from-slate-900/50 to-slate-800/50 rounded-xl p-4">
        <h3 class="text-lg font-semibold text-cyan-50 mb-3">Seçilen Eser</h3>
        <p class="result-text text-cyan-200">Çarkı çevirip durduğunda seçilen eser burada gözükecek.</p>
        <div class="result-card hidden" id="resultCard"></div>
      </div>

      <!-- 3. kutu: Alt satırda, mobilde tam, md'de 2/3, lg'de 3/5 -->
      <div class="md:col-span-2 lg:col-span-3 lg:row-start-5 bg-yellow-200 p-4">
        <div style="display:flex;gap:10px;align-items:center">
          <button id="spinBtn" class="w-full py-4 px-6 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-lg transition-colors cursor-pointer select-none" aria-pressed="false">Basılı Tut → Dön</button>
        </div>
        <p class="text-sm text-cyan-100 bg-cyan-950/30 rounded-lg p-3">
          Mobil: butona basılı tutun veya üzerine dokunun. Bıraktığınızda seçtiğiniz süre içinde duracak şekilde yavaşlar.
        </p>
        <div class="flex justify-between items-center text-sm text-cyan-100 bg-slate-900/50 rounded-lg p-3">
          <div style="font-size:13px;color:#cfe8ff"><strong>Hız:</strong> <span id="speedLabel">0.00</span> rad/s</div>
          <div style="font-size:13px;color:#cfe8ff"><strong>Durma:</strong> <span id="stopTarget">3.5</span>s</div>
        </div>
        <label class="text-sm text-cyan-100 flex flex-col gap-2">
          Durma süresi ayarla:
          <input id="stopRange" type="range" min="2" max="5" step="0.1" value="3.5" class="w-full">
        </label>
      </div>

      <!-- 4. kutu: Alt satır sağda -->
      <div class="md:col-span-1 md:col-start-3 lg:col-span-2 lg:col-start-4 lg:row-start-5 bg-red-200 p-4">
        <label for="jsonFile" class="block text-sm font-medium text-cyan-100 mb-3">Kartları JSON Dosyasından Yükle (isteğe bağlı):</label>
        <input type="file" id="jsonFile" accept="application/json" class="block w-full text-sm text-cyan-100 mb-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-600 file:text-white file:font-semibold hover:file:bg-cyan-700 file:cursor-pointer">
        <button id="loadJsonBtn" class="px-6 py-2 bg-cyan-500 hover:bg-cyan-600 text-slate-950 font-bold rounded-lg transition-colors">YÜKLE</button>
        <p class="text-xs text-cyan-200 mt-3">
          Eğer dosya yüklemezseniz, sunucuya yüklenmiş örnek JSON (varsa) otomatik kullanılır.
        </p>
      </div>
    </div>

  <script>
    // Configuration
    let NUM_CABINS = 12;
    const RIM_RADIUS = 180;
    const CABIN_DIST = RIM_RADIUS;
    const CABIN_SIZE = 28;
    const LIGHT_COUNT = NUM_CABINS * 6;

    // Physics
    let angle = 0; // radians
    let angVel = 0; // radians / sec
    let pressing = false;

    const maxAngVel = 6.0;
    const accelWhilePress = 4.0;
    const stopTargetInput = document.getElementById('stopRange');

    // refs
    const svg = document.getElementById('svgWheel');
    const wheelGroup = document.getElementById('wheelGroup');
    const spokesGroup = document.getElementById('spokes');
    const lightsGroup = document.getElementById('lights');
    const starsGroup = document.getElementById('stars');
    const spinBtn = document.getElementById('spinBtn');
    const speedLabel = document.getElementById('speedLabel');
    const stopTargetLabel = document.getElementById('stopTarget');

    // default literaryWorks (fallback)
    let literaryWorks = [
      { "id":"1","Başlık": "Alice Harikalar Diyarında", "Tür": "Kitap", "Yazar": "Lewis Carroll", "Metin": "Alice, bir tavşan deliğinden düşerek fantastik bir dünyaya ulaşır." },
      { "id":"2","Başlık": "Martılar", "Tür": "Şiir", "Yazar": "Cahit Sıtkı Tarancı", "Metin": "Martılara özlemle bakış..." },
      { "id":"3","Başlık": "İnce Memed", "Tür": "Edebi Metin", "Yazar": "Yaşar Kemal", "Metin": "Her insan öldürür gene de sevdiğini\nBu böyle bilinsin herkes tarafından,\nKiminin ters bakışından gelir ölüm,\nKiminin iltifatından,\nKorkağın öpücüğünden,\nCesurun kılıcından!\n\nKimisi aşkını gençlikte öldürür,\nYaşını başını almışken kimi;\nBiri Şehvet'in elleriyle boğazlar,\nBirinin altındır elleri,\nYumuşak kalpli bıçak kullanır\nÇünkü ceset soğur hemen.\n\nKimi pek az sever, kimi derinden,\nBiri müşteridir, diğeri satıcı;\nKimi vardır, gözyaşlarıyla bitirir işi,\nKiminden ne bir ah, ne bir figan:\nÇünkü her insan öldürür sevdiğini,\nGene de ölmez insan." }
    ];

    // Try to fetch sample JSON (uploaded to server as sample_cards.json) and use if available.
    fetch('./sample_cards.json').then(r=>{
      if(!r.ok) throw new Error('no sample');
      return r.json();
    }).then(js=>{
      if(Array.isArray(js) && js.length>0){
        literaryWorks = js;
        NUM_CABINS = literaryWorks.length;
        console.log('Sample JSON loaded from server,', js.length, 'items');
      }
      // After potential load, create the cabins
      createCabinsAndLights();
    }).catch(err=>{
      console.log('No sample JSON loaded from server - using defaults.');
      createCabinsAndLights();
    });

    // helper
    function svgn(tag){ return document.createElementNS('http://www.w3.org/2000/svg', tag); }

    // create stars
    (function createStars(){
      const W = 900, H = 520;
      for(let i=0;i<120;i++){
        const x = Math.random()*W;
        const y = Math.random()*H*0.7;
        const r = Math.random()*1.6 + 0.3;
        const c = svgn('circle');
        c.setAttribute('cx', x);
        c.setAttribute('cy', y);
        c.setAttribute('r', r);
        c.setAttribute('fill', 'white');
        c.setAttribute('opacity', (Math.random()*0.7+0.2).toFixed(2));
        starsGroup.appendChild(c);
      }
    })();

    
    // 0-bazlı alttaki kabin indeksi (her NUM_CABINS için doğru çalışır)
    function getBottomCabinIndex(currentAngleRad, cabinCount){
      const twoPi = 2*Math.PI;
      // Açıyı [0, 2π) aralığına normalize et
      let a = currentAngleRad % twoPi;
      if (a < 0) a += twoPi;

      const step = twoPi / cabinCount;
      // Geometri: i ≈ (π - a) / step  0-bazlı, en yakın kabini bulmak için yuvarla
      let idx = Math.round((Math.PI - a) / step) % cabinCount;
      if (idx < 0) idx += cabinCount;
      return idx; // 0..cabinCount-1
    }

    // createCabinsAndLights - now a proper function (callable)
    function createCabinsAndLights(){
      while(spokesGroup.firstChild) spokesGroup.removeChild(spokesGroup.firstChild);
      while(lightsGroup.firstChild) lightsGroup.removeChild(lightsGroup.firstChild);

      for(let i=0;i<NUM_CABINS;i++){
        // start numbering at top (12 o'clock) and go clockwise
        const theta = (i/NUM_CABINS)*Math.PI*2 - Math.PI/2;
        const line = svgn('line');
        line.setAttribute('x1',0); line.setAttribute('y1',0);
        line.setAttribute('x2', Math.cos(theta)*RIM_RADIUS);
        line.setAttribute('y2', Math.sin(theta)*RIM_RADIUS);
        line.setAttribute('stroke','#1b495c'); line.setAttribute('stroke-width','3');
        spokesGroup.appendChild(line);

        const cabinG = svgn('g');
        cabinG.setAttribute('class','cabinG'); cabinG.setAttribute('data-index', i);
        const cx = Math.cos(theta)*CABIN_DIST; const cy = Math.sin(theta)*CABIN_DIST;
        cabinG.setAttribute('transform', `translate(${cx} ${cy})`);

        const arm = svgn('line'); arm.setAttribute('x1',0); arm.setAttribute('y1',0); arm.setAttribute('x2',0); arm.setAttribute('y2',18);
        arm.setAttribute('stroke','#0b1b22'); arm.setAttribute('stroke-width','2'); cabinG.appendChild(arm);

        const rect = svgn('rect'); rect.setAttribute('x', -CABIN_SIZE/2); rect.setAttribute('y', 18);
        rect.setAttribute('width', CABIN_SIZE); rect.setAttribute('height', CABIN_SIZE*0.8); rect.setAttribute('rx',6);
        rect.setAttribute('class','cabin'); rect.setAttribute('fill', getColorForIndex(i)); rect.setAttribute('stroke','#9b6a00'); rect.setAttribute('stroke-width','1.5');
        cabinG.appendChild(rect);

        const win = svgn('rect'); win.setAttribute('x', -6); win.setAttribute('y', 22); win.setAttribute('width', 12); win.setAttribute('height', 12); win.setAttribute('rx',2); win.setAttribute('fill','#fff'); win.setAttribute('opacity','0.95'); cabinG.appendChild(win);

        // numbering: top == 12
        //const cabinNumber = i === 0 ? NUM_CABINS : i;
        const cabinNumber = i + 1;
        const num = svgn('text'); num.setAttribute('class','cabinNumberNight'); num.setAttribute('x','0');
        const cabinCenterY = 18 + (CABIN_SIZE*0.8)/2 + 4; num.setAttribute('y', cabinCenterY); num.setAttribute('text-anchor','middle'); num.textContent = String(cabinNumber);
        cabinG.appendChild(num);

        spokesGroup.appendChild(cabinG);
      }

      // lights
      for(let i=0;i<LIGHT_COUNT;i++){
        const theta = (i/LIGHT_COUNT)*Math.PI*2 - Math.PI/2;
        const lx = Math.cos(theta)*(RIM_RADIUS+10);
        const ly = Math.sin(theta)*(RIM_RADIUS+10);
        const light = svgn('circle'); light.setAttribute('cx', lx); light.setAttribute('cy', ly); light.setAttribute('r',5);
        light.setAttribute('class','rimLight'); light.dataset.index = i; lightsGroup.appendChild(light);
      }
    }

    function getColorForIndex(i){
      const palette = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFBE0B", "#FB5607", "#8338EC", "#3A86FF", "#06D6A0", "#FF9E00", "#9B5DE5", "#00BBF9", "#F15BB5"];
      return palette[i % palette.length];
    }

    // JSON upload handler (user file)
    document.getElementById('loadJsonBtn').addEventListener('click', loadJsonData);

    function loadJsonData(){
      const fileInput = document.getElementById('jsonFile'); const file = fileInput.files[0];
      if(!file){ alert('Lütfen bir JSON dosyası seçin!'); return; }
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const jsonData = JSON.parse(e.target.result);
          if(Array.isArray(jsonData) && jsonData.length>0){ literaryWorks = jsonData; NUM_CABINS = literaryWorks.length; createCabinsAndLights(); alert(`${literaryWorks.length} kart başarıyla yüklendi!`); }
          else alert('JSON doğru formatta bir dizi içermiyor.');
          // no writing anywhere — just use in memory
        }catch(err){ alert('JSON ayrıştırma hatası: '+err.message); }
        // update visuals even if number of cabins stays 12
        createCabinsAndLights();
      };
      reader.readAsText(file);
    }

    // animation loop
    let lastTs = null; let releaseDecel = 0;

    function startPress(e){ e.preventDefault(); pressing = true; spinBtn.textContent = 'BASILI TUTULUYOR...'; spinBtn.setAttribute('aria-pressed','true'); }
    function endPress(e){ if(e) e.preventDefault(); if(!pressing) return; pressing = false; const stopTime = parseFloat(stopTargetInput.value) || 3.5; releaseDecel = -angVel / stopTime; spinBtn.textContent = 'DURDURULUYOR...'; spinBtn.setAttribute('aria-pressed','false'); setTimeout(showSelectedResult, stopTime*1000); }

    spinBtn.addEventListener('mousedown', startPress); spinBtn.addEventListener('touchstart', startPress, {passive:false});
    spinBtn.addEventListener('mouseup', endPress); spinBtn.addEventListener('touchend', endPress); spinBtn.addEventListener('mouseleave', endPress);

    function showSelectedResult(){
      // Alttaki kabinin 0-bazlı indeksini bul
      const cabinIndex = getBottomCabinIndex(angle, NUM_CABINS);

      // Eser dizisine indeksle, taşma varsa mod al
      const workIndex = cabinIndex % literaryWorks.length;
      const work = literaryWorks[workIndex] || { Başlık:'Başlıksız', Tür:'—', Yazar:'—', Metin:'—' };

      const resultCard = document.getElementById('resultCard');
      resultCard.innerHTML = `
        <h3>${escapeHtml(work['Başlık']||work['title']||'Başlıksız')}</h3>
        <p><span class="type">${escapeHtml(work['Tür']||work['type']||'Tür yok')}</span></p>
        <p><strong>Yazar:</strong> ${escapeHtml(work['Yazar']||work['author']||'Yok')}</p>
        <p class="text">${escapeHtml(work['Metin']||work['text']||'İçerik yok')}</p>
      `;
      resultCard.classList.remove('hidden');
      document.querySelector('.result-text').classList.add('hidden');
      spinBtn.textContent = 'TEKRAR ÇEVİR!';
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function update(ts){ if(!lastTs) lastTs = ts; const dt = (ts-lastTs)/1000; lastTs = ts;
      if(pressing){ angVel += accelWhilePress * dt; if(angVel>maxAngVel) angVel = maxAngVel; }
      else { if(angVel>0){ angVel += releaseDecel * dt; if(angVel < 0.00005) angVel = 0; } }
      angle += angVel * dt;
      if(angVel === 0){ const snapStep = (2*Math.PI)/NUM_CABINS; angle = Math.round(angle / snapStep) * snapStep; }
      const deg = angle * 180/Math.PI; wheelGroup.setAttribute('transform', `translate(450 360) rotate(${deg})`);

      // cabins upright
      const cabinGroups = document.querySelectorAll('.cabinG'); cabinGroups.forEach(cg=>{
        const i = +cg.getAttribute('data-index'); const theta = (i/NUM_CABINS)*Math.PI*2 - Math.PI/2; const cx = Math.cos(theta)*CABIN_DIST; const cy = Math.sin(theta)*CABIN_DIST; cg.setAttribute('transform', `translate(${cx} ${cy}) rotate(${-deg})`);
      });

      // lights rainbow
      const lights = document.querySelectorAll('.rimLight'); lights.forEach(lt=>{ const i = +lt.dataset.index; const hueBase = (i / LIGHT_COUNT) * 360; const hueShift = (angle * 180/Math.PI) * 0.4; const hue = (hueBase + hueShift) % 360; const pulse = 0.7 + 0.3*Math.sin(angle*3 + i*0.5); lt.setAttribute('fill', `hsl(${hue},100%,${50*pulse}%)`); });

      speedLabel.textContent = angVel.toFixed(2);
      requestAnimationFrame(update);
    }

    // start loop
    requestAnimationFrame(update);

    // make stop range label reactive
    stopTargetInput.addEventListener('input', ()=>{ stopTargetLabel.textContent = stopTargetInput.value; });
    window.addEventListener('blur', ()=>{ if(pressing) endPress(); });

  </script>
</body>
</html>
