<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Edebiyat Çarkı</title>
  <style>
    :root{
      --bg:#071428; /* gece gökyüzü */
      --wheel:#2a6f9e;
      --spoke:#1f4f6a;
      --leg:#6b4b3a;
      --shadow: rgba(0,0,0,0.32);
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:var(--bg); display:flex;align-items:center;justify-content:center}
    .wrap{width:980px;max-width:96vw;padding:18px;background:linear-gradient(180deg,#071428 0%, #0b2a3a 100%);border-radius:12px;box-shadow:0 10px 40px var(--shadow);color:#e7f6ff}
    h1{font-size:18px;margin:0 0 12px;color:#dbefff}
    /* layout: wheel on left, controls+card on right */
    .stage{display:flex;gap:20px;align-items:flex-start}
    .canvas{width:62%;display:flex;align-items:center;justify-content:center;min-height:520px}
    .controls{width:38%;display:flex;flex-direction:column;align-items:stretch;gap:12px}
    .text{white-space: pre-line;}
    button.spin-btn{width:100%;padding:14px;border-radius:10px;border:none;background:#1f7bd6;color:white;font-weight:600;cursor:pointer;user-select:none}
    .hint{margin-top:6px;font-size:13px;color:#cfe8ff}
    /* make the SVG responsive */
    svg{max-width:100%;height:auto;display:block}
    /* cabin style */
    .cabin{stroke:#b26e00;stroke-width:1}
    .cabinNumberNight{font-size:12px;fill:#102027;font-weight:800}
    /* subtle shadow under wheel */
    .ground{fill:#071a28}

    /* Custom styles for literary content */
    .json-upload {
      text-align: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      width: 100%;
    }

    .json-upload input { display:block;margin:8px auto;padding:10px;border:2px dashed #4ecdc4;border-radius:8px;width:85%;background:transparent;color:#e7f6ff }
    .json-upload button { padding:8px 14px;background:#4ecdc4;color:#032027;border:none;border-radius:8px;cursor:pointer;font-weight:700 }

    .result-container { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius: 12px; padding: 14px; width:100%; box-shadow: 0 6px 18px rgba(0,0,0,0.4)}
    .result-title { color: #dbefff; margin:0 0 8px 0 }
    .result-card { background: linear-gradient(135deg, rgba(110, 203, 245, 0.07), rgba(194, 233, 251, 0.04)); border-radius: 10px; padding: 14px; border:1px solid rgba(255,255,255,0.04)}
    .result-card h3{margin:0;color:#fff}
    .result-card p{margin:8px 0;color:#cfe8ff}
    .type { background:#ff6b6b;color:white;padding:4px 8px;border-radius:12px;font-weight:700 }

    @media (max-width: 900px) {
      .stage{flex-direction:column}
      .canvas{width:100%}
      .controls{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="text-align:center;">Edebiyat Çarkı</h1>

    <div class="stage">
      <div class="canvas">
        <!-- SVG ferris wheel -->
        <svg id="svgWheel" viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg" aria-label="Dönme dolap örneği">
          <!-- sky background -->
          <rect id="sky" x="0" y="0" width="900" height="520" fill="#02102a" />

          <!-- stars group (generated in JS) -->
          <g id="stars"></g>

          <!-- ground / shadow -->
          <rect x="0" y="520" width="900" height="80" fill="#071a28"/>
          <ellipse id="groundShadow" cx="450" cy="560" rx="160" ry="24" fill="rgba(0,0,0,0.45)"/>

          <!-- legs: adjusted so they touch the ground and look straight -->
          <g id="legs">
            <!-- left leg -->
            <path d="M390 560 L420 320 L438 320 L408 560 Z" fill="var(--leg)" opacity="0.95"/>
            <!-- right leg -->
            <path d="M510 560 L480 320 L462 320 L492 560 Z" fill="var(--leg)" opacity="0.95"/>
            <!-- foot plates to anchor legs to ground -->
            <rect x="376" y="552" width="70" height="12" rx="4" fill="#2a1b14" opacity="0.95"/>
            <rect x="454" y="552" width="70" height="12" rx="4" fill="#2a1b14" opacity="0.95"/>
            <!-- cross braces (slightly lower) -->
            <rect x="410" y="420" width="80" height="10" rx="5" fill="#1e1a17" transform="rotate(-10 450 425)"/>
            <rect x="410" y="440" width="80" height="10" rx="5" fill="#1e1a17" transform="rotate(10 450 445)"/>
          </g>

          <!-- wheel group (we will rotate this group). center Y moved down -->
          <g id="wheelGroup" transform="translate(450 360)">
            <!-- lights around rim (generated in JS) -->
            <g id="lights"></g>

            <!-- outer rim -->
            <circle cx="0" cy="0" r="180" fill="none" stroke="#0d4a6f" stroke-width="14" />
            <!-- inner rim -->
            <circle cx="0" cy="0" r="140" fill="none" stroke="#13364a" stroke-width="6" />

            <!-- spokes & cabins generated in JS for cleaner code; placeholder here -->
            <g id="spokes"></g>

            <!-- hub -->
            <circle cx="0" cy="0" r="20" fill="#0f2b3a" />
            <circle cx="0" cy="0" r="10" fill="#1b4b68" />
          </g>

          <!-- pivot cover to hide center join -->
          <circle id="pivotCover" cx="450" cy="360" r="22" fill="#071a28"/>
        </svg>
      </div>

      <div class="controls">
        <div style="display:flex;gap:10px;align-items:center">
          <button id="spinBtn" class="spin-btn" aria-pressed="false">Basılı Tut → Dön</button>
        </div>
        <div class="hint">Mobil: butona basılı tutun veya üzerine dokunun. Bıraktığınızda seçtiğiniz süre içinde duracak şekilde yavaşlar.</div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div style="font-size:13px;color:#cfe8ff"><strong>Hız:</strong> <span id="speedLabel">0.00</span> rad/s</div>
          <div style="font-size:13px;color:#cfe8ff"><strong>Durma:</strong> <span id="stopTarget">3.5</span>s</div>
        </div>
        <label style="font-size:13px;color:#cfe8ff">Durma süresi ayarla: <input id="stopRange" type="range" min="2" max="5" step="0.1" value="3.5" style="width:100%"></label>

        <div class="result-container">
          <h3 class="result-title">Seçilen Eser</h3>
          <div class="result-content">
            <p class="result-text">Çarkı çevirip durduğunda seçilen eser burada gözükecek.</p>
            <div class="result-card hidden" id="resultCard"></div>
          </div>
        </div>
        <div class="json-upload">
          <label for="jsonFile">Kartları JSON Dosyasından Yükle (isteğe bağlı):</label>
          <input type="file" id="jsonFile" accept="application/json">
          <div style="margin-top:8px"><button id="loadJsonBtn">YÜKLE</button></div>
          <div style="font-size:12px;color:#bfe9ff;margin-top:8px">Eğer dosya yüklemezseniz, sunucuya yüklenmiş örnek JSON (varsa) otomatik kullanılır.</div>
        </div>
    </div>
    </div>
  </div>

  <script>
    // Configuration
    const NUM_CABINS = 12;
    const RIM_RADIUS = 180;
    const CABIN_DIST = RIM_RADIUS;
    const CABIN_SIZE = 28;
    const LIGHT_COUNT = NUM_CABINS * 6;

    // Physics
    let angle = 0; // radians
    let angVel = 0; // radians / sec
    let pressing = false;

    const maxAngVel = 6.0;
    const accelWhilePress = 4.0;
    const stopTargetInput = document.getElementById('stopRange');

    // refs
    const svg = document.getElementById('svgWheel');
    const wheelGroup = document.getElementById('wheelGroup');
    const spokesGroup = document.getElementById('spokes');
    const lightsGroup = document.getElementById('lights');
    const starsGroup = document.getElementById('stars');
    const spinBtn = document.getElementById('spinBtn');
    const speedLabel = document.getElementById('speedLabel');
    const stopTargetLabel = document.getElementById('stopTarget');

    // default literaryWorks (fallback)
    let literaryWorks = [
      { "id":"1","Başlık": "Alice Harikalar Diyarında", "Tür": "Kitap", "Yazar": "Lewis Carroll", "Metin": "Alice, bir tavşan deliğinden düşerek fantastik bir dünyaya ulaşır." },
      { "id":"2","Başlık": "Martılar", "Tür": "Şiir", "Yazar": "Cahit Sıtkı Tarancı", "Metin": "Martılara özlemle bakış..." },
      { "id":"3","Başlık": "İnce Memed", "Tür": "Edebi Metin", "Yazar": "Yaşar Kemal", "Metin": "Her insan öldürür gene de sevdiğini\nBu böyle bilinsin herkes tarafından,\nKiminin ters bakışından gelir ölüm,\nKiminin iltifatından,\nKorkağın öpücüğünden,\nCesurun kılıcından!\n\nKimisi aşkını gençlikte öldürür,\nYaşını başını almışken kimi;\nBiri Şehvet'in elleriyle boğazlar,\nBirinin altındır elleri,\nYumuşak kalpli bıçak kullanır\nÇünkü ceset soğur hemen.\n\nKimi pek az sever, kimi derinden,\nBiri müşteridir, diğeri satıcı;\nKimi vardır, gözyaşlarıyla bitirir işi,\nKiminden ne bir ah, ne bir figan:\nÇünkü her insan öldürür sevdiğini,\nGene de ölmez insan." }
    ];

    // Try to fetch sample JSON (uploaded to server as sample_cards.json) and use if available.
    fetch('./sample_cards.json').then(r=>{
      if(!r.ok) throw new Error('no sample');
      return r.json();
    }).then(js=>{
      if(Array.isArray(js) && js.length>0){
        literaryWorks = js;
        console.log('Sample JSON loaded from server,', js.length, 'items');
      }
      // After potential load, create the cabins
      createCabinsAndLights();
    }).catch(err=>{
      console.log('No sample JSON loaded from server - using defaults.');
      createCabinsAndLights();
    });

    // helper
    function svgn(tag){ return document.createElementNS('http://www.w3.org/2000/svg', tag); }

    // create stars
    (function createStars(){
      const W = 900, H = 520;
      for(let i=0;i<120;i++){
        const x = Math.random()*W;
        const y = Math.random()*H*0.7;
        const r = Math.random()*1.6 + 0.3;
        const c = svgn('circle');
        c.setAttribute('cx', x);
        c.setAttribute('cy', y);
        c.setAttribute('r', r);
        c.setAttribute('fill', 'white');
        c.setAttribute('opacity', (Math.random()*0.7+0.2).toFixed(2));
        starsGroup.appendChild(c);
      }
    })();

    function getCabinAtBottom() {
        let closestIndex = 0;
        let minDiff = Infinity;

        for (let i = 0; i < NUM_CABINS; i++) {
            const theta = (i / NUM_CABINS) * Math.PI * 2;
            const diff = Math.abs((theta + angle) % (2 * Math.PI) - Math.PI / 2); // en alt = 90 derece (PI/2)

            if (diff < minDiff) {
            minDiff = diff;
            if (i>10) i = i - 12;
            closestIndex = i+2;
            }
        }

        return closestIndex + 1; // kabin numarası 1-12
    }
    // createCabinsAndLights - now a proper function (callable)
    function createCabinsAndLights(){
      while(spokesGroup.firstChild) spokesGroup.removeChild(spokesGroup.firstChild);
      while(lightsGroup.firstChild) lightsGroup.removeChild(lightsGroup.firstChild);

      for(let i=0;i<NUM_CABINS;i++){
        // start numbering at top (12 o'clock) and go clockwise
        const theta = (i/NUM_CABINS)*Math.PI*2 - Math.PI/2;
        const line = svgn('line');
        line.setAttribute('x1',0); line.setAttribute('y1',0);
        line.setAttribute('x2', Math.cos(theta)*RIM_RADIUS);
        line.setAttribute('y2', Math.sin(theta)*RIM_RADIUS);
        line.setAttribute('stroke','#1b495c'); line.setAttribute('stroke-width','3');
        spokesGroup.appendChild(line);

        const cabinG = svgn('g');
        cabinG.setAttribute('class','cabinG'); cabinG.setAttribute('data-index', i);
        const cx = Math.cos(theta)*CABIN_DIST; const cy = Math.sin(theta)*CABIN_DIST;
        cabinG.setAttribute('transform', `translate(${cx} ${cy})`);

        const arm = svgn('line'); arm.setAttribute('x1',0); arm.setAttribute('y1',0); arm.setAttribute('x2',0); arm.setAttribute('y2',18);
        arm.setAttribute('stroke','#0b1b22'); arm.setAttribute('stroke-width','2'); cabinG.appendChild(arm);

        const rect = svgn('rect'); rect.setAttribute('x', -CABIN_SIZE/2); rect.setAttribute('y', 18);
        rect.setAttribute('width', CABIN_SIZE); rect.setAttribute('height', CABIN_SIZE*0.8); rect.setAttribute('rx',6);
        rect.setAttribute('class','cabin'); rect.setAttribute('fill', getColorForIndex(i)); rect.setAttribute('stroke','#9b6a00'); rect.setAttribute('stroke-width','1.5');
        cabinG.appendChild(rect);

        const win = svgn('rect'); win.setAttribute('x', -6); win.setAttribute('y', 22); win.setAttribute('width', 12); win.setAttribute('height', 12); win.setAttribute('rx',2); win.setAttribute('fill','#fff'); win.setAttribute('opacity','0.95'); cabinG.appendChild(win);

        // numbering: top == 12
        const cabinNumber = i === 0 ? 12 : i;
        const num = svgn('text'); num.setAttribute('class','cabinNumberNight'); num.setAttribute('x','0');
        const cabinCenterY = 18 + (CABIN_SIZE*0.8)/2 + 4; num.setAttribute('y', cabinCenterY); num.setAttribute('text-anchor','middle'); num.textContent = String(cabinNumber);
        cabinG.appendChild(num);

        spokesGroup.appendChild(cabinG);
      }

      // lights
      for(let i=0;i<LIGHT_COUNT;i++){
        const theta = (i/LIGHT_COUNT)*Math.PI*2 - Math.PI/2;
        const lx = Math.cos(theta)*(RIM_RADIUS+10);
        const ly = Math.sin(theta)*(RIM_RADIUS+10);
        const light = svgn('circle'); light.setAttribute('cx', lx); light.setAttribute('cy', ly); light.setAttribute('r',5);
        light.setAttribute('class','rimLight'); light.dataset.index = i; lightsGroup.appendChild(light);
      }
    }

    function getColorForIndex(i){
      const palette = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#FFBE0B", "#FB5607", "#8338EC", "#3A86FF", "#06D6A0", "#FF9E00", "#9B5DE5", "#00BBF9", "#F15BB5"];
      return palette[i % palette.length];
    }

    // JSON upload handler (user file)
    document.getElementById('loadJsonBtn').addEventListener('click', loadJsonData);
    function loadJsonData(){
      const fileInput = document.getElementById('jsonFile'); const file = fileInput.files[0];
      if(!file){ alert('Lütfen bir JSON dosyası seçin!'); return; }
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const jsonData = JSON.parse(e.target.result);
          if(Array.isArray(jsonData) && jsonData.length>0){ literaryWorks = jsonData; alert(`${literaryWorks.length} kart başarıyla yüklendi!`); }
          else alert('JSON doğru formatta bir dizi içermiyor.');
          // no writing anywhere — just use in memory
        }catch(err){ alert('JSON ayrıştırma hatası: '+err.message); }
        // update visuals even if number of cabins stays 12
        createCabinsAndLights();
      };
      reader.readAsText(file);
    }

    // animation loop
    let lastTs = null; let releaseDecel = 0;

    function startPress(e){ e.preventDefault(); pressing = true; spinBtn.textContent = 'BASILI TUTULUYOR...'; spinBtn.setAttribute('aria-pressed','true'); }
    function endPress(e){ if(e) e.preventDefault(); if(!pressing) return; pressing = false; const stopTime = parseFloat(stopTargetInput.value) || 3.5; releaseDecel = -angVel / stopTime; spinBtn.textContent = 'DURDURULUYOR...'; spinBtn.setAttribute('aria-pressed','false'); setTimeout(showSelectedResult, stopTime*1000); }

    spinBtn.addEventListener('mousedown', startPress); spinBtn.addEventListener('touchstart', startPress, {passive:false});
    spinBtn.addEventListener('mouseup', endPress); spinBtn.addEventListener('touchend', endPress); spinBtn.addEventListener('mouseleave', endPress);

    function showSelectedResult(){
      // normalize angle
      let normalizedAngle = angle % (2*Math.PI); if(normalizedAngle<0) normalizedAngle += 2*Math.PI;
      const bottomAngle = (normalizedAngle + Math.PI) % (2*Math.PI);
      const cabinIndex = Math.floor((bottomAngle / (2*Math.PI)) * NUM_CABINS) % NUM_CABINS;
    const hesapCabinIndex = getCabinAtBottom();

    
      const workIndex = cabinIndex % literaryWorks.length; 
      
      const work = literaryWorks.find(item => item.id === workIndex.toString());


      const resultCard = document.getElementById('resultCard');

      resultCard.innerHTML = `
        <h3>${escapeHtml(work['Başlık']||work['title']||'Başlıksız')}</h3>
        <p><span class=\"type\">${escapeHtml(work['Tür']||work['type']||'Tür yok')}</span></p>
        <p><strong>Yazar:</strong> ${escapeHtml(work['Yazar']||work['author']||'Yok')}</p>
        <p class="text">${escapeHtml(work['Metin']||work['text']||'İçerik yok')}</p>
      `;
      resultCard.classList.remove('hidden'); document.querySelector('.result-text').classList.add('hidden'); spinBtn.textContent = 'TEKRAR ÇEVİR!';
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function update(ts){ if(!lastTs) lastTs = ts; const dt = (ts-lastTs)/1000; lastTs = ts;
      if(pressing){ angVel += accelWhilePress * dt; if(angVel>maxAngVel) angVel = maxAngVel; }
      else { if(angVel>0){ angVel += releaseDecel * dt; if(angVel < 0.00005) angVel = 0; } }
      angle += angVel * dt;
      if(angVel === 0){ const snapStep = (2*Math.PI)/NUM_CABINS; angle = Math.round(angle / snapStep) * snapStep; }
      const deg = angle * 180/Math.PI; wheelGroup.setAttribute('transform', `translate(450 360) rotate(${deg})`);

      // cabins upright
      const cabinGroups = document.querySelectorAll('.cabinG'); cabinGroups.forEach(cg=>{
        const i = +cg.getAttribute('data-index'); const theta = (i/NUM_CABINS)*Math.PI*2 - Math.PI/2; const cx = Math.cos(theta)*CABIN_DIST; const cy = Math.sin(theta)*CABIN_DIST; cg.setAttribute('transform', `translate(${cx} ${cy}) rotate(${-deg})`);
      });

      // lights rainbow
      const lights = document.querySelectorAll('.rimLight'); lights.forEach(lt=>{ const i = +lt.dataset.index; const hueBase = (i / LIGHT_COUNT) * 360; const hueShift = (angle * 180/Math.PI) * 0.4; const hue = (hueBase + hueShift) % 360; const pulse = 0.7 + 0.3*Math.sin(angle*3 + i*0.5); lt.setAttribute('fill', `hsl(${hue},100%,${50*pulse}%)`); });

      speedLabel.textContent = angVel.toFixed(2);
      requestAnimationFrame(update);
    }

    // start loop
    requestAnimationFrame(update);

    // make stop range label reactive
    stopTargetInput.addEventListener('input', ()=>{ stopTargetLabel.textContent = stopTargetInput.value; });
    window.addEventListener('blur', ()=>{ if(pressing) endPress(); });

  </script>
</body>
</html>
